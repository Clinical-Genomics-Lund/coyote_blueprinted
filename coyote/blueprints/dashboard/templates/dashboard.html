{% extends "layout.html" %}
{% block style %}
  <link href="{{ url_for('dashboard_bp.static', filename='css/db_style.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
<div class="container mx-auto py-10">
  <!-- Top Cards Row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
    <div class="card bg-gradient-to-r from-blue-400 to-blue-600 text-black shadow-lg rounded-xl p-8 relative overflow-hidden transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl">
        <h2 class="text-xl font-semibold mb-2">Total Samples</h2>
        <p class="text-4xl font-extrabold">{{ total_samples }}</p>
    </div>
    <div class="card bg-white text-black shadow-lg rounded-xl p-8 relative overflow-hidden border-4 border-green-400 transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl">
      <div class="fill bg-green-400" style="width: {{ analysed_samples / total_samples * 100 }}%;"></div>
          <h2 class="text-xl font-semibold mb-2 relative z-10">Samples Analysed</h2>
          <p class="text-4xl font-extrabold relative z-10">{{ analysed_samples }}</p>
    </div>
    <div class="card bg-white text-black shadow-lg rounded-xl p-8 relative overflow-hidden border-4 border-red-400 transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl">
      <div class="fill bg-red-400" style="width: {{ pending_samples|int / total_samples|int * 100 }}%;"></div>
        <h2 class="text-xl font-semibold mb-2 relative z-10">Samples Pending</h2>
        <p class="text-4xl font-extrabold relative z-10">{{ pending_samples }}</p>
    </div>
  </div>

  <!-- Modern Chart Row -->
  <div class="flex justify-center mb-10">
    <div class="card bg-white shadow-lg rounded-xl p-4 w-1/3 m-4">
      <canvas id="multiLevelChart" width="50" height="50"></canvas>
    </div>

  <!-- Classification Stats Row -->
    <div class="card bg-white shadow-lg rounded-xl p-4 w-1/3 m-4">
      <canvas id="classificationChart" width="50" height="50"></canvas>
    </div>

  <!-- Assay Stats Row -->
    <div class="card bg-white shadow-lg rounded-xl p-4 w-1/3 m-4">
      <canvas id="assayChart" width="50" height="50"></canvas>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript">
  const totalSamplesData = {{ total_samples_data | safe }};
  const analysedSamplesData = {{ analysed_samples_data | safe }};
  const pendingSamplesData = {{ pending_samples_data | safe }};
  const classStatsData = {{ class_stats_data | safe }};
  const assayClassStatsData = {{ assay_class_stats_data | safe }};

  function createMultiLevelChart(ctx) {
    const totalLabels = Object.keys(totalSamplesData);
    const totalValues = Object.values(totalSamplesData);
    const analysedValues = Object.values(analysedSamplesData);
    const pendingValues = Object.values(pendingSamplesData);

    const colors = totalLabels.map((_, index) => `hsl(${index * 360 / totalLabels.length}, 70%, 50%)`);

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: totalLabels,
        datasets: [
          {
            label: 'Total Samples',
            data: totalValues,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 8,  // Increased borderWidth to create gap between rings
            hoverOffset: 10,
          },
          {
            label: 'Analysed Samples',
            data: analysedValues,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 8,  // Increased borderWidth to create gap between rings
            hoverOffset: 10,
          },
          {
            label: 'Pending Samples',
            data: pendingValues,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 8,  // Increased borderWidth to create gap between rings
            hoverOffset: 10,
          }
        ]
      },
      options: {
        responsive: true,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#243b55',
              padding: 10,
              font: {
                size: 10,
                weight: 'normal'
              }
            }
          },
          title: {
            display: true,
            text: 'Samples Overview Per Assay and Status',
            color: '#243b55',
            font: {
              size: 18,
              weight: 'bold'
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return `${label}: ${value}`;
              }
            }
          },
          annotation: {
            annotations: {
              text1: {
                type: 'label',
                xValue: 'Total Samples',
                yValue: 0,
                content: ['Total Samples'],
                color: '#000',
                font: {
                  size: 14
                },
                position: 'outside'
              },
              text2: {
                type: 'label',
                xValue: 'Analysed Samples',
                yValue: 0,
                content: ['Analysed Samples'],
                color: '#000',
                font: {
                  size: 14
                },
                position: 'outside'
              },
              text3: {
                type: 'label',
                xValue: 'Pending Samples',
                yValue: 0,
                content: ['Pending Samples'],
                color: '#000',
                font: {
                  size: 14
                },
                position: 'outside'
              }
            }
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        },
        hover: {
          onHover: function(e) {
            const point = this.getElementAtEvent(e);
            if (point.length) e.target.style.cursor = 'pointer';
            else e.target.style.cursor = 'default';
          }
        }
      }
    });
  }

  function createClassificationBarChart(ctx, data, title) {
    const categories = Object.keys(data);
    const classLabels = [];
    const datasetMap = {};

    // Gather all unique class labels
    categories.forEach(category => {
      const classData = data[category];
      Object.keys(classData).forEach(classLabel => {
        if (!classLabels.includes(classLabel)) {
          classLabels.push(classLabel);
        }
      });
    });

    // Prepare dataset for each class label
    classLabels.forEach(classLabel => {
      datasetMap[classLabel] = {
        label: `Class ${classLabel}`,
        data: [],
        backgroundColor: `hsl(${classLabel * 90}, 70%, 50%)`,  // Different colors for each class
        borderColor: '#fff',
        borderWidth: 2,
        hoverOffset: 10,
      };
    });

    // Fill data for each class in each category
    categories.forEach(category => {
      const classData = data[category];
      classLabels.forEach(classLabel => {
        const value = classData[classLabel] || 0;
        datasetMap[classLabel].data.push(value);
      });
    });

    const datasets = Object.values(datasetMap);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: categories,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#243b55',
              font: {
                size: 10,
                weight: 'normal'
              }
            }
          },
          title: {
            display: true,
            text: title,
            color: '#243b55',
            font: {
              size: 18,
              weight: 'bold'
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw;
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Nomenclature',
              color: '#243b55',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          y: {
            title: {
              display: true,
              text: 'Counts',
              color: '#243b55',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            beginAtZero: true  // Ensure the y-axis starts at 0
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        },
        hover: {
          onHover: function(e) {
            const point = this.getElementAtEvent(e);
            if (point.length) e.target.style.cursor = 'pointer';
            else e.target.style.cursor = 'default';
          }
        }
      }
    });
  }

  function createAssayBarChart(ctx, data, title) {
    const assays = Object.keys(data);
    const classLabels = new Set();
    const datasetMap = {};

    // Collect all unique class labels across all assays
    assays.forEach(assay => {
      const subCategoryData = data[assay];
      Object.keys(subCategoryData).forEach(subCategory => {
        const classData = subCategoryData[subCategory];
        Object.keys(classData).forEach(classLabel => {
          classLabels.add(classLabel);
        });
      });
    });

    // Convert classLabels set to array
    const classLabelsArray = Array.from(classLabels);

    // Initialize datasets for each class
    classLabelsArray.forEach((classLabel, index) => {
      datasetMap[classLabel] = {
        label: `Class ${classLabel}`,
        data: [],
        backgroundColor: `hsl(${index * 90}, 70%, 50%)`,
        borderColor: '#fff',
        borderWidth: 2,
        hoverOffset: 10,
      };
    });

    // Populate datasets with data
    assays.forEach(assay => {
      const subCategoryData = data[assay];
      classLabelsArray.forEach(classLabel => {
        let totalCount = 0;
        Object.keys(subCategoryData).forEach(subCategory => {
          const classData = subCategoryData[subCategory] || {};
          totalCount += classData[classLabel] || 0;
        });
        datasetMap[classLabel].data.push(totalCount);
      });
    });

    const datasets = Object.values(datasetMap);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: assays,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#243b55',
              font: {
                size: 10,
                weight: 'normal'
              }
            }
          },
          title: {
            display: true,
            text: title,
            color: '#243b55',
            font: {
              size: 18,
              weight: 'bold'
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw;
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Assays',
              color: '#243b55',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          y: {
            title: {
              display: true,
              text: 'Counts',
              color: '#243b55',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            beginAtZero: true  // Ensure the y-axis starts at 0
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        },
        hover: {
          onHover: function(e) {
            const point = this.getElementAtEvent(e);
            if (point.length) e.target.style.cursor = 'pointer';
            else e.target.style.cursor = 'default';
          }
        }
      }
    });
  }

  window.onload = function() {
    createMultiLevelChart(document.getElementById('multiLevelChart'));
    createClassificationBarChart(document.getElementById('classificationChart'), classStatsData, 'Variant Classification Stats');
    createAssayBarChart(document.getElementById('assayChart'), assayClassStatsData, 'Assay Specific Variant Classification Stats');
  };
</script>
{% endblock %}
