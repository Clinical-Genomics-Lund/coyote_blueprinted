{% extends "layout.html" %} {% block body %} {% set translation=config["TRANS"]
%} <span class="genefilter_generic">Sample:</span
><a href="{{ url_for('fusions_bp.list_fusions', id=sample.name) }}">
  {{ sample.name }}</a
>

<h1>Handling RNA Sample: {{ id }}</h1>

<div id="top_div">
  <div id="variantlist_div">
    {% if fusions|length > 0 %}
    <span class="table_header">Fusions passing filter criteria</span>
    <table class="sortable" id="fusion_list_table">
      <thead>
        <tr>
          <th nowrap>Gene 1</th>
          <th nowrap>Gene 2</th>
          <th>Effect</th>
          <th nowrap>Spanning pairs</th>
          <th nowrap data-autoclick="true">Unique spanning reads</th>
          <th>Fusion points</th>
          <th>Tier</th>
          <th>Description</th>
          <th>Callers</th>
          <th>View</th>
        </tr>
      </thead>

      {% for fus in fusions %} {% set genes = fus.genes.split('^') %} {% set
      sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) |list)[0] %}
      {#{fus}#} {% if fus.blacklisted or fus.fp %}
      <tr class="fp">
        {% else %}
      </tr>

      <tr>
        {% endif %}
        <td>{{ genes[0] }}</td>
        <td>{{ genes[1] }}</td>
        <td>{{ sel_fus.effect }}</td>
        <td>{{ sel_fus.spanpairs }}</td>
        <td>{{ sel_fus.spanreads }}</td>
        <td>{{ sel_fus.breakpoint1 }}<br />{{ sel_fus.breakpoint2 }}</td>

        <td class="varlist" sorttable_customkey="{{fus.classification.class}}">
          {% if fus.classification.class != 999 %}
          <div class="classbox_table" id="tier{{ fus.classification.class }}">
            {{ fus.classification.class }}
          </div>
          {% endif %}
        </td>

        <td>
          {{ sel_fus.desc|format_fusion_desc|safe }} {#% if "desc" in sel_fus %}
          {{ sel_fus["desc"].split(',')|join(', ') }} {% endif %#}
        </td>
        <td>{{ fus.calls|uniq_callers|join("<br />")|safe }}</td>
        <td><a href="../fusion/{{fus._id}}">view</a></td>
      </tr>
      {% endfor %}
    </table>
    {% endif %} {% if sample.classification %}
    <span class="table_header"
      >Expression-based classification
      ({{sample.classification.classifier_version}})</span
    >
    <table class="sortable" id="fusion_list_table" style="width: 320px">
      <thead>
        <tr>
          <th>Class</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        {% for c in sample.classification.classifier_results %}
        <tr>
          <td>{{ c.class }}</td>
          <td>
            <div
              style="
                text-align: center;
                position: relative;
                z-index: 1;
                width: 200px;
                height: 100%;
                margin: 0px 0px;
                border: 1px solid rgb(50, 50, 50);
              "
            >
              <div
                style="position:absolute;z-index:-1;width:{{ (c.score * 100)|string }}%;height:100%;background-color:#acf;"
              ></div>
              {{ '%0.2f'| format(c.score) }}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %} {% if sample.expr %}
    <span class="table_header">Expression levels of selected genes</span>
    <table class="sortable" id="fusion_list_table" style="width: 320px">
      <thead>
        <th>Gene</th>
        <th>TPM</th>
        <th>TPM mean</th>
        <th>Z-score</th>
      </thead>
      <tbody>
        {% for data in sample.expr.sample %} {% if data.hgnc_symbol %}
        <tr>
          {% set zscore = data.z %}
          <td>{{ data.hgnc_symbol }}</td>
          <td>{{ '%0.2f'| format(data.sample_expression)}}</td>
          <td>{{ '%0.2f'| format(data.reference_mean)}}</td>
          <td>
            {% if zscore >= 0 %}
            <div
              style="
                text-align: left;
                padding-left: 2px;
                position: relative;
                z-index: 1;
                width: 200px;
                height: 100%;
                margin: 0px 0px;
                border: 1px solid rgb(50, 50, 50);
              "
            >
              <div
                style="
                  position: absolute;
                  left: 100px;
                  z-index: 0;
                  width: 1px;
                  height: 100%;
                  background-color: #555;
                "
              ></div>
              <div
                style="position:absolute;left:101px;z-index:-1;width:{{ 2+ zscore * 6 }}px;height:100%;background-color:#8E8;"
              ></div>
              {{ '%0.2f'| format(zscore) }}
            </div>
            {% else %}
            <div
              style="
                text-align: left;
                padding-left: 2px;
                position: relative;
                z-index: 1;
                width: 200px;
                height: 100%;
                margin: 0px 0px;
                border: 1px solid rgb(50, 50, 50);
              "
            >
              <div
                style="
                  position: absolute;
                  left: 100px;
                  z-index: 0;
                  width: 1px;
                  height: 100%;
                  background-color: #555;
                "
              ></div>
              <div
                style="position:absolute;left:{{ 100+zscore*6 }}px;z-index:-1;width:{{ -zscore * 6 +1 }}px;height:100%;background-color:#faa;"
              ></div>
              {{ '%0.2f'| format(zscore) }}
            </div>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>

  <div id="right_div">
    <div id="filter_div">
      <form action="" method="POST" name="form">
        {{ form.hidden_tag() }}
        <table>
          <thead>
            <tr>
              <th>Modify filters</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="fusion_filters">
              <td colspan="2"><b>Fusion filters</b></td>
            </tr>
            <tr class="fusion_filters">
              <td>
                <label class="control-label">Spanning pairs</label>
                {% for error in form.min_spanpairs.errors %}
                <span style="color: red">{{ error }}</span>
                {% endfor %}
              </td>
              <td>
                &gt; {{ form.min_spanpairs( size=1,
                default=sample.filter_min_spanpairs ) }}
              </td>
            </tr>
            <tr class="fusion_filters">
              <td>
                <label class="control-label">Spanning reads</label>
                {% for error in form.min_spanreads.errors %}
                <span style="color: red">{{ error }}</span>
                {% endfor %}
              </td>
              <td>
                &gt; {{ form.min_spanreads( size=1,
                default=sample.filter_min_spanreads ) }}
              </td>
            </tr>
            <tr class="fusion_filters">
              <td colspan="2">
                <div class="multiselect">
                  <div
                    class="selectBox"
                    onclick="showCheckboxes('fusionlists_checkboxes')"
                  >
                    <select>
                      <option>Fusion gene lists</option>
                    </select>
                    <div class="overSelect"></div>
                  </div>
                  <div id="fusionlists_checkboxes" class="checkboxes">
                    <label for="FCknown"
                      >{{ form.fusionlist_FCknown(checked=False) }}
                      FusionCatcher 'known'</label
                    >
                    <label for="mitelman"
                      >{{ form.fusionlist_mitelman(checked=False) }}
                      Mitelman</label
                    >
                  </div>
                </div>
              </td>
            </tr>
            <tr class="fusion_filters">
              <td colspan="2">
                <div class="multiselect">
                  <div
                    class="selectBox"
                    onclick="showCheckboxes('fusioncallers_checkboxes')"
                  >
                    <select>
                      <option>Fusion callers</option>
                    </select>
                    <div class="overSelect"></div>
                  </div>
                  <div id="fusioncallers_checkboxes" class="checkboxes">
                    <label for="arriba"
                      >{{ form.fusioncaller_arriba(checked=False) }}
                      Arriba</label
                    >
                    <label for="fusioncatcher"
                      >{{ form.fusioncaller_fusioncatcher(checked=False) }}
                      FusionCatcher</label
                    >
                    <label for="starfusion"
                      >{{ form.fusioncaller_starfusion(checked=False) }}
                      StarFusion</label
                    >
                  </div>
                </div>
              </td>
            </tr>
            <tr class="fusion_filters">
              <td colspan="2">
                <div class="multiselect">
                  <div
                    class="selectBox"
                    onclick="showCheckboxes('fusioneffect_checkboxes')"
                  >
                    <select>
                      <option>Fusion effects</option>
                    </select>
                    <div class="overSelect"></div>
                  </div>
                  <div id="fusioneffect_checkboxes" class="checkboxes">
                    <label for="inframe"
                      >{{ form.fusioneffect_inframe(checked=False) }}
                      In-frame</label
                    >
                    <label for="outframe"
                      >{{ form.fusioneffect_outframe(checked=False) }}
                      Out-of-frame</label
                    >
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <button
                  class="btn btn-default"
                  name="apply"
                  value="apply"
                  type="submit"
                >
                  Apply
                </button>
                <button
                  class="btn btn-default"
                  name="reset"
                  value="reset"
                  type="submit"
                >
                  Reset
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </form>
    </div>
  </div>
</div>

<div id="sample_comments">
  {% if sample.comments|length > 0 %}
  <span class="table_header">Sample comments</span>
  <table class="comments">
    <thead>
      <tr>
        <th>Who</th>
        <th>Comment</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for comment in sample.comments|sort(attribute='time_created',
      reverse=True) %} {% if comment.hidden != 1 %}
      <tr>
        {% else %}
      </tr>

      <tr class="hidden_comment hidden">
        {% endif %}
        <td class="comment" style="white-space: nowrap">
          <b>{{ comment.author }}</b><br /><small
            >{{ comment.time_created }}</small
          >
        </td>
        <td class="comment" onclick="addText(event)">
          {{ comment.text|format_comment|safe }}
        </td>
        <td class="comment">
          {% set hidden_exists = 0 %} {% if comment.hidden != 1 %}
          <form
            action="{{ url_for('hide_sample_comment', sample_id=sample._id) }}"
            method="post"
          >
            <input type="hidden" name="comment_id" value="{{ comment._id }}" />
            <input
              id="hide_comment"
              type="image"
              width="15"
              src="{{ url_for('static', filename='delete.png') }}"
            />
          </form>
          {% else %} {% set hidden_exists = 1 %}
          <form
            action="{{ url_for('unhide_sample_comment', sample_id=sample._id) }}"
            method="post"
          >
            <input type="hidden" name="comment_id" value="{{ comment._id }}" />
            <input
              id="unhide_comment"
              type="image"
              width="15"
              src="{{ url_for('static', filename='unhide.png') }}"
            />
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %} {% if hidden_comments == 1 %}
      <tr>
        <td
          colspan="4"
          style="
            border-top: 1px solid #ccc;
            font-size: 10px;
            padding-bottom: 2px;
            padding-top: 2px;
            text-align: center;
          "
        >
          <a
            href="javascript:void(0)"
            onclick="switchVisibility('hidden_comment')"
            ><b>Show/hide deleted comments</b></a
          >
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
  {% endif %}
  <form
    action="{{ url_for('add_sample_comment', id=sample._id) }}"
    method="post"
  >
    <textarea
      style="height: 140px"
      id="comment_textarea"
      name="sample_comment"
      placeholder="Enter sample comment..."
    ></textarea
    ><br />
    <input type="submit" value="Save comment" />
    <a class="button" href="javascript:void(0)" onclick="addAIText()"
      >Suggest</a
    >
  </form>
  <div id="suggestion" style="display: none">{{ai_text}}</div>
</div>

<script>
  function addText(event) {
    var targ = event.target || event.srcElement;
    document.getElementById("comment_textarea").value =
      targ.textContent || targ.innerText;
  }

  function addAIText() {
    document.getElementById("comment_textarea").value =
      document.getElementById("suggestion").innerHTML;
  }

  window.onload = function () {
    $('[data-autoclick="true"]').click();
    $('[data-autoclick="true"]').click();
    $('[data-autoclick-once="true"]').click();
  };

  var expanded = false;
  function showCheckboxes(id) {
    var checkboxes = document.getElementById(id);
    if (!expanded) {
      checkboxes.style.display = "block";
      expanded = true;
    } else {
      checkboxes.style.display = "none";
      expanded = false;
    }
  }

  function show_lowcov() {
    if (document.getElementById("lowcovlist_div").style.display == "none") {
      document.getElementById("lowcovlist_div").style.display = "block";
    } else {
      document.getElementById("lowcovlist_div").style.display = "none";
    }
  }

  function show_germlinecnv() {
    if (document.getElementById("germline_div").style.display == "none") {
      document.getElementById("germline_div").style.display = "block";
    } else {
      document.getElementById("germline_div").style.display = "none";
    }
  }

  function switchVisibility(class_name) {
    var hide_class = "hidden";

    var elems = document.getElementsByClassName(class_name);

    for (var i = 0; i < elems.length; i++) {
      if (elems[i].classList.contains(hide_class)) {
        elems[i].classList.remove(hide_class);
      } else {
        elems[i].classList.add(hide_class);
      }
    }
  }
</script>

<style>
  .multiselect {
    width: 100%;
  }

  .selectBox {
    position: relative;
  }

  .selectBox select {
    width: 100%;
  }

  .overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }

  .checkboxes {
    display: none;
    border-bottom: 1px #bbb solid;
    border-left: 1px #bbb solid;
    border-right: 1px #bbb solid;
    border-radius: 0px 0px 3px 3px;
    background-color: #fff;
  }

  .checkboxes label {
    display: block;
  }

  .checkboxes label:hover {
    background-color: #f7f7ff;
  }
</style>

{% endblock %}
